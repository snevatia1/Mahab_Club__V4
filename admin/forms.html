<!doctype html>
<html>
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Forms</title><link rel="stylesheet" href="../client/static/styles.css"/></head>
<body>
<header class="site-header"><div class="titles"><h1>Admin Forms</h1><p class="subtitle">Edit JSON safely, download and upload to /data</p></div><nav><a class="btn ghost" href="./">Back</a></nav></header>
<main class="container"><section class="card">
<div class="grid two">
  <div>
    <h3>Policies</h3>
    <label>Test Mode</label><select id="test"><option>true</option><option>false</option></select>
    <label>Payment URL</label><input id="pay" placeholder="https://..."/>
    <label>Months per view</label><input id="mpv" type="number" min="1" max="12"/>
    <label>Weekend days (0=Sun...6=Sat)</label><input id="wk" placeholder="5,6"/>
    <div class="actions"><button id="dlPol" class="btn">Download policies.json</button></div>
  </div>
  <div>
    <h3>Promotions</h3>
    <label>Weekday 3-for-2</label><select id="p_w3"><option>false</option><option>true</option></select>
    <label>Flat %</label><input id="p_fp" type="number" min="0" max="50" value="0"/>
    <label>Weekday %</label><input id="p_wp" type="number" min="0" max="50" value="0"/>
    <div class="actions"><button id="dlProm" class="btn">Download promotions.json</button></div>
  </div>
</div>
<div class="grid two" style="margin-top:12px">
  <div>
    <h3>Tariff</h3>
    <label>GST %</label><input id="gst" type="number" min="0" max="28"/>
    <div class="actions"><button id="dlTar" class="btn">Download tariff.json</button></div>
  </div>
  <div>
    <h3>Calendar overlay</h3>
    <textarea id="cal" rows="8" style="width:100%" placeholder='{"2025-11-07":{"bbq":true}}'></textarea>
    <div class="actions"><button id="dlCal" class="btn">Download calendar.json</button></div>
  </div>
</div>
</section></main>
<script>
let POL, TAR, PROM, CAL; async function init(){
  [POL,TAR,PROM,CAL] = await Promise.all([
    fetch('../data/policies.json').then(r=>r.json()),
    fetch('../data/tariff.json').then(r=>r.json()),
    fetch('../data/promotions.json').then(r=>r.json()),
    fetch('../data/calendar.json').then(r=>r.json())
  ]);
  document.getElementById('test').value = String(POL.test_mode);
  document.getElementById('pay').value = POL.payment?.pay_url||'';
  document.getElementById('mpv').value = POL.ui?.months_per_view||6;
  document.getElementById('wk').value = (POL.auto_calendar?.weekend_days||[5,6]).join(',');
  document.getElementById('gst').value = TAR.tax?.gst_pct||12;
  document.getElementById('cal').value = JSON.stringify(CAL, null, 2);
}
function dl(name, obj){ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(obj,null,2)); a.download=name; a.click(); }
document.addEventListener('DOMContentLoaded', init);
document.getElementById('dlPol').onclick = ()=>{
  const wk = document.getElementById('wk').value.split(',').map(x=>+x.trim()).filter(x=>!isNaN(x));
  POL.test_mode = (document.getElementById('test').value==='true');
  POL.ui = POL.ui||{}; POL.ui.months_per_view = +document.getElementById('mpv').value||6;
  POL.auto_calendar = POL.auto_calendar||{}; POL.auto_calendar.weekend_days = wk.length? wk : [5,6];
  POL.payment = POL.payment||{}; POL.payment.pay_url = document.getElementById('pay').value||'';
  dl('policies.json', POL);
};
document.getElementById('dlProm').onclick = ()=>{
  PROM.weekday_3for2.enabled = (document.getElementById('p_w3').value==='true');
  PROM.flat_percent.value = +document.getElementById('p_fp').value||0;
  PROM.flat_percent.enabled = PROM.flat_percent.value>0;
  PROM.weekday_percent.value = +document.getElementById('p_wp').value||0;
  PROM.weekday_percent.enabled = PROM.weekday_percent.value>0;
  dl('promotions.json', PROM);
};
document.getElementById('dlTar').onclick = ()=>{
  TAR.tax = TAR.tax||{}; TAR.tax.gst_pct = +document.getElementById('gst').value||12;
  dl('tariff.json', TAR);
};
document.getElementById('dlCal').onclick = ()=>{
  try{ CAL = JSON.parse(document.getElementById('cal').value||'{}'); }catch(e){ alert('Invalid JSON'); return; }
  dl('calendar.json', CAL);
};
</script>
</body></html>
